<!-- 
============================================
WebDAV æµè§ˆå™¨å¢å¼ºè„šæœ¬
åŠŸèƒ½ï¼šä¸º Nginx autoindex æ·»åŠ åˆ é™¤æŒ‰é’®
ç‰ˆæœ¬ï¼š1.0 (ä¿®å¤ç‰ˆ)
============================================
-->
<style>
  /* åˆ é™¤æŒ‰é’®æ ·å¼ */
  .webdav-delete-btn {
    cursor: pointer;
    color: #dc3545;
    font-size: 0.9em;
    margin-left: 10px;
    text-decoration: none;
    padding: 2px 6px;
    border: 1px solid #dc3545;
    border-radius: 3px;
    transition: all 0.2s;
  }
  
  .webdav-delete-btn:hover {
    background-color: #dc3545;
    color: white;
    text-decoration: none;
  }
  
  /* æ–‡ä»¶/ç›®å½•å›¾æ ‡ä¼˜åŒ– */
  a[href$="/"]::before {
    content: "ğŸ“ ";
  }
  
  a:not([href$="/"])::before {
    content: "ğŸ“„ ";
  }
  
  a[href="../"]::before,
  a[href=".."]::before {
    content: "â¬†ï¸ ";
  }
  
  /* å“åº”å¼å¸ƒå±€ */
  @media (max-width: 768px) {
    .webdav-delete-btn {
      font-size: 0.8em;
      padding: 1px 4px;
      margin-left: 5px;
    }
  }
  
  /* åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ï¼ˆå¯é€‰ï¼‰ */
  .webdav-confirm-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    z-index: 10000;
    display: none;
  }
  
  .webdav-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    display: none;
  }
</style>

<script>
(function() {
  'use strict';
  
  // é…ç½®
  const CONFIG = {
    deleteButtonText: '[åˆ é™¤]',
    confirmMessage: 'ç¡®è®¤åˆ é™¤',
    successMessage: 'åˆ é™¤æˆåŠŸï¼',
    errorMessage: 'åˆ é™¤å¤±è´¥',
    retryOn409: true,  // é‡åˆ° 409 æ—¶å°è¯•ä¸å¸¦å°¾éƒ¨æ–œæ é‡è¯•
    debug: false       // è°ƒè¯•æ¨¡å¼
  };
  
  // æ—¥å¿—å‡½æ•°
  function log(...args) {
    if (CONFIG.debug) {
      console.log('[WebDAV]', ...args);
    }
  }
  
  // åˆ é™¤å‡½æ•°
  function deleteItem(url, isDirectory, itemName) {
    log('Attempting to delete:', url);
    
    return fetch(url, {
      method: 'DELETE',
      credentials: 'same-origin',  // åŒ…å«è®¤è¯ cookie
      headers: {
        'Accept': '*/*',
        'Cache-Control': 'no-cache'
      }
    })
    .then(response => {
      log('Delete response:', response.status, response.statusText);
      
      // æˆåŠŸçŠ¶æ€ç ï¼š204 No Content, 200 OK, 404 Not Found (å·²ç»ä¸å­˜åœ¨)
      if (response.ok || response.status === 204 || response.status === 404) {
        return { success: true, status: response.status };
      }
      
      // 409 Conflict - å°è¯•ä¸å¸¦å°¾éƒ¨æ–œæ é‡è¯•
      if (response.status === 409 && CONFIG.retryOn409 && url.endsWith('/')) {
        log('Got 409, retrying without trailing slash...');
        const retryUrl = url.slice(0, -1);  // ç§»é™¤å°¾éƒ¨æ–œæ 
        
        return fetch(retryUrl, {
          method: 'DELETE',
          credentials: 'same-origin',
          headers: {
            'Accept': '*/*',
            'Cache-Control': 'no-cache'
          }
        })
        .then(retryResponse => {
          log('Retry response:', retryResponse.status);
          
          if (retryResponse.ok || retryResponse.status === 204 || retryResponse.status === 404) {
            return { success: true, status: retryResponse.status };
          } else {
            return { 
              success: false, 
              status: retryResponse.status,
              error: `HTTP ${retryResponse.status}`
            };
          }
        });
      }
      
      // å…¶ä»–é”™è¯¯
      return { 
        success: false, 
        status: response.status,
        error: `HTTP ${response.status} ${response.statusText}`
      };
    })
    .catch(error => {
      log('Delete error:', error);
      return { 
        success: false, 
        error: error.message || 'ç½‘ç»œé”™è¯¯'
      };
    });
  }
  
  // åˆå§‹åŒ–åˆ é™¤æŒ‰é’®
  function initDeleteButtons() {
    log('Initializing delete buttons...');
    
    // è·å–æ‰€æœ‰é“¾æ¥
    const links = document.querySelectorAll('a');
    let buttonCount = 0;
    
    links.forEach(link => {
      const href = link.getAttribute('href');
      
      // è·³è¿‡æ— æ•ˆé“¾æ¥å’Œçˆ¶ç›®å½•é“¾æ¥
      if (!href || href === '../' || href === '..' || href === '/') {
        return;
      }
      
      // åˆ¤æ–­æ˜¯å¦ä¸ºç›®å½•ï¼ˆä»¥ / ç»“å°¾ï¼‰
      const isDirectory = href.endsWith('/');
      
      // è·å–æ˜¾ç¤ºåç§°
      const itemName = link.textContent.trim() || decodeURIComponent(href);
      
      // åˆ›å»ºåˆ é™¤æŒ‰é’®
      const deleteBtn = document.createElement('a');
      deleteBtn.className = 'webdav-delete-btn';
      deleteBtn.textContent = CONFIG.deleteButtonText;
      deleteBtn.href = '#';
      deleteBtn.title = `åˆ é™¤ ${isDirectory ? 'ç›®å½•' : 'æ–‡ä»¶'}: ${itemName}`;
      
      // åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      deleteBtn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // ç¡®è®¤åˆ é™¤
        const confirmMsg = `${CONFIG.confirmMessage} ${isDirectory ? 'ç›®å½•' : 'æ–‡ä»¶'}:\n\n${itemName}\n\n${isDirectory ? 'âš ï¸ æ³¨æ„ï¼šç›®å½•å¿…é¡»ä¸ºç©ºæ‰èƒ½åˆ é™¤' : ''}`;
        
        if (!confirm(confirmMsg)) {
          return;
        }
        
        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        deleteBtn.style.pointerEvents = 'none';
        deleteBtn.style.opacity = '0.5';
        deleteBtn.textContent = '[åˆ é™¤ä¸­...]';
        
        // æ„å»ºå®Œæ•´çš„åˆ é™¤ URL
        const currentPath = window.location.pathname;
        let deleteUrl = currentPath;
        
        // ç¡®ä¿è·¯å¾„ä»¥ / ç»“å°¾
        if (!deleteUrl.endsWith('/')) {
          deleteUrl += '/';
        }
        
        // æ·»åŠ è¦åˆ é™¤çš„é¡¹ç›®
        deleteUrl += href;
        
        // å…³é”®ï¼šç¡®ä¿ç›®å½• URL ä»¥ / ç»“å°¾
        if (isDirectory && !deleteUrl.endsWith('/')) {
          deleteUrl += '/';
        }
        
        // æ‰§è¡Œåˆ é™¤
        deleteItem(deleteUrl, isDirectory, itemName)
          .then(result => {
            if (result.success) {
              alert(`${CONFIG.successMessage}\n${itemName}`);
              // åˆ·æ–°é¡µé¢
              window.location.reload();
            } else {
              alert(`${CONFIG.errorMessage}:\n${itemName}\n\né”™è¯¯: ${result.error}`);
              // æ¢å¤æŒ‰é’®
              deleteBtn.style.pointerEvents = '';
              deleteBtn.style.opacity = '';
              deleteBtn.textContent = CONFIG.deleteButtonText;
            }
          });
      };
      
      // åœ¨é“¾æ¥åæ’å…¥åˆ é™¤æŒ‰é’®
      link.parentNode.insertBefore(deleteBtn, link.nextSibling);
      buttonCount++;
    });
    
    log(`Added ${buttonCount} delete buttons`);
  }
  
  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDeleteButtons);
  } else {
    // DOM å·²ç»åŠ è½½å®Œæˆ
    initDeleteButtons();
  }
  
  log('WebDAV delete script loaded');
})();
</script>

<!-- 
ä½¿ç”¨è¯´æ˜ï¼š
1. æ­¤æ–‡ä»¶é€šè¿‡ Nginx add_after_body æŒ‡ä»¤è‡ªåŠ¨æ³¨å…¥åˆ° autoindex é¡µé¢
2. ä¼šåœ¨æ¯ä¸ªæ–‡ä»¶/ç›®å½•é“¾æ¥åæ·»åŠ  [åˆ é™¤] æŒ‰é’®
3. ç‚¹å‡»åˆ é™¤æŒ‰é’®ä¼šå¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
4. åˆ é™¤æˆåŠŸåè‡ªåŠ¨åˆ·æ–°é¡µé¢
5. ç›®å½•å¿…é¡»ä¸ºç©ºæ‰èƒ½åˆ é™¤ï¼ˆNginx åŸºç¡€ DAV æ¨¡å—é™åˆ¶ï¼‰

é…ç½®ç¤ºä¾‹ï¼ˆNginxï¼‰ï¼š
location /webdav/ {
    alias /var/ftp/files/;
    autoindex on;
    autoindex_format html;
    add_after_body /webdav_footer.html;  # æ³¨å…¥æ­¤è„šæœ¬
    dav_methods PUT DELETE MKCOL COPY MOVE;
    ...
}
-->
