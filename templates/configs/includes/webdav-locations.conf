# ============================================
# WebDAV Location 配置
# ============================================
# 使用 ^~ 提高匹配优先级
location ^~ /webdav/ {
    alias @@FTP_PATH@@/;
    
    # 目录索引设置
    autoindex on;
    autoindex_exact_size off;
    autoindex_localtime on;
    
    # 输出为 HTML 以支持脚本注入
    autoindex_format html;
    charset utf-8;
    
    # 注入浏览器端管理脚本
    add_after_body /webdav_footer.html;
    
    # WebDAV 方法支持
    dav_methods PUT DELETE MKCOL COPY MOVE;
    dav_access user:rw group:rw all:r;
    create_full_put_path on;
    
    # 基础认证
    auth_basic "WebDAV";
    auth_basic_user_file @@HTPASSWD_FILE@@;
    
    # 传输性能设置
    client_max_body_size 0;
    client_body_buffer_size 1m;
    client_body_temp_path @@WEBDAV_TEMP@@;
    proxy_request_buffering off;
    
    # 超时设置
    client_body_timeout 600s;
    send_timeout 600s;
    
    tcp_nopush on;
    tcp_nodelay on;
    sendfile on;
    sendfile_max_chunk 1m;
    
    # 兼容性设置：OPTIONS 响应
    if ($request_method = OPTIONS) {
        add_header Allow "GET, HEAD, POST, PUT, DELETE, OPTIONS, MKCOL, COPY, MOVE" always;
        add_header DAV "1" always;
        add_header MS-Author-Via "DAV" always;
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 200;
    }
    
    # 兼容性设置：PROPFIND 重写
    if ($request_method = PROPFIND) {
        rewrite ^ $uri break;
    }
    
    # 兼容性设置：Destination 头修正
    set $dest $http_destination;
    if ($http_destination ~ "^https://(.+)") {
        set $dest http://$1;
    }
    
    add_header X-Content-Type-Options "nosniff" always;
    add_header Cache-Control "no-store, no-cache" always;
    
    access_log /var/log/nginx/webdav_access.log;
    error_log /var/log/nginx/webdav_error.log warn;
}

# 健康检查接口
location /webdav-health {
    access_log off;
    return 200 "WebDAV OK (Basic Mode)";
    add_header Content-Type text/plain;
}
